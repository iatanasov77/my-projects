#!/bin/bash

if [[ $EUID -ne 0 ]]; then
   echo "You must to be root." 
   exit 1
fi

PHPBREW_PREFIX="/opt/phpbrew"
PHP_VERSION=$1
COMMAND=$2

start()
{
    
    local configFile="${PHPBREW_PREFIX}/php/php-${PHP_VERSION}/etc/php-fpm.d/www.conf"
    local fpmCommand="${PHPBREW_PREFIX}/php/php-${PHP_VERSION}/sbin/php-fpm"
    
    if [ ! -f "$configFile" ]; then
        echo "$configFile does not exist"
        # MAY BE YOU SHOULD INSTALL VERSION
    fi
    
    prepairConfig ${configFile}
    
    eval $fpmCommand
    
    echo "SUCCESS !!!" 
}

restartFpm()
{
    service httpd stop
    phpbrew fpm stop
    rm -f ${PHPBREW_PREFIX}/php/php-${PHP_VERSION}/var/run/php-fpm.sock
    phpbrew fpm start
    service httpd start
}

prepairConfig()
{
    local configFile=$1
    
    sed -i 's/nobody/apache/g' ${configFile}
    
    # Uncomment lines
    sed -i "s/^;\{0,1\}listen\.owner *= *[^ ]*/listen.owner = apache/" ${configFile}
    sed -i "s/^;\{0,1\}listen\.group *= *[^ ]*/listen.group = apache/" ${configFile}
    sed -i "s/^;\{0,1\}listen\.mode *= *[^ ]*/listen.mode = 0660/" ${configFile}
    sed -i "s/^;\{0,1\}listen\.allowed_clients *= *[^ ]*/listen.allowed_clients = 127.0.0.1/" ${configFile}
}

setStatus()
{
    echo "Set Status"
}

usage()
{
    echo "usage: phpfpm [php_version] [command]"
    exit 1
}

[ -z $1 ] && usage

case $COMMAND in
    start)
        start
        exit 1
        ;;
    restartFpm)
        restartFpm
        exit 1
        ;;
    *)
        start
        exit 1
esac
